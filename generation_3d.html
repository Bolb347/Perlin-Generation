<!-- Use the generation without 3d for testing for new generation (this one is a lot slower)-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

<script>
  let camx = 0;
  let camy = -100;
  let camz = 0;
  let waterLevel = -16;

  let pixels = [];
  function setup() {
    createCanvas(400, 400, WEBGL);
    for (var x = 0; x < 100; x ++) {
      for (var y = 0; y < 100; y ++) {
        var biome;
        let zoom = 10
        if (noise(x/zoom, y/zoom) < 0.3) {
          biome = 'ocean';
        } else if (noise(x/zoom, y/zoom) < 0.5) {
          biome = 'plains';
          if (Math.random() < 0.001) {
            biome = 'village';
          }
        } else if (noise(x/zoom, y/zoom) < 0.7) {
          biome = 'forest';
        } else if (noise(x/zoom, y/zoom) <= 1) {
          biome = 'mountains';
        }
        let c = 0;
        if (biome === 'plains') {
          c = color(0, 255-(noise(x/zoom, y/zoom)*150), 0);
        } else if (biome === 'forest') {
          c = color(0, 255-(noise(x/zoom, y/zoom)*200), 0);
        } else if (biome === 'mountains') {
          c = color(255-(noise(x/zoom, y/zoom)*200), 255-(noise(x/zoom, y/zoom)*200), 255-(noise(x/zoom, y/zoom)*200));
        } else if (biome === 'ocean') {
          c = color(0, 0, 255-(noise(x/zoom, y/zoom)*200));
        } else if (biome === 'village') {
          c = color(150, 75, 0);
        }
        pixels.push([biome, x, y, noise(x/zoom, y/zoom), c]);
      }
    }
  }

  function draw() {
    background(220);
    
    keyPressed();

    camera(camx, camy, camz, 200, 0, 200)
    
    orbitControl();
  
    for (var x = 0; x < 99; x ++) {
      beginShape(TRIANGLE_STRIP);
      for (var y = 0; y < 100; y ++) {
        strokeWeight(0.1);
        stroke(0);
        //stroke(lerpColor(pixels[x * 100 + y][4], pixels[x * 100 + y + 100][4], 1));
        if (pixels[x * 100 + y][0] === 'village') {
          fill(color(150, 75, 0));
          translate(x*4, 0-pixels[x * 100 + y][3]*50, y*4);
          box(4, 4, 4);
          fill(pixels[x * 100 + y + 100][4]);
          translate(-(x*4), pixels[x * 100 + y][3]*50, -(y*4))
        } else {
          fill(lerpColor(pixels[x * 100 + y][4], pixels[x * 100 + y + 100][4], 1));
        }
        vertex(x*4, 0-pixels[x * 100 + y][3]*50, y*4);
        vertex(x*4+4, 0-pixels[x * 100 + y + 100][3]*50, y*4);
      }
      endShape();
    }
  }

  function keyPressed() {
    if (keyCode === LEFT_ARROW && keyIsPressed) {
      camx = camx + 8;
    } else if (keyCode === RIGHT_ARROW && keyIsPressed) {
      camx = camx - 8;
    } else if (keyCode === UP_ARROW && keyIsPressed) {
      camz = camz + 8;
    } else if (keyCode === DOWN_ARROW && keyIsPressed) {
      camz = camz - 8;
    } else if (key === 'w' && keyIsPressed) {
      camy = camy - 8;
    } else if (key === 's' && keyIsPressed) {
      camy = camy + 8;
    }
  }
</script>
